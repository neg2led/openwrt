// SPDX-License-Identifier: GPL-2.0-or-later OR MIT
#include "qcom-ipq8064.dtsi"
#include <dt-bindings/input/input.h>
#include <dt-bindings/gpio/gpio.h>

/ {
	model = "Sophos APX530";
	compatible = "sophos,apx530", "qcom,ipq8064";


	aliases {
		led-boot = &led_status_green;
		led-failsafe = &led_status_red;
		led-running = &led_status_green;
		led-upgrade = &led_status_red;

		serial0 = &gsbi4_serial; /* ttyMSM0, console */
		serial1 = &gsbi2_serial; /* ttyMSM1, bluetooth */
		ethernet0 = &gmac2;
		ethernet1 = &gmac3;
	};

	chosen {
		stdout-path = "serial0:115200n8";
		bootargs = "ubi.mtd=rootfs loglevel=8 earlycon=msm_serial_dm,0x16340000 earlyprink console=ttyMSM0,115200";
	};

	memory@42000000 {
		reg = <0x42000000 0x3e000000>;
		device_type = "memory";
	};

	reserved-memory {
		#address-cells = <1>;
		#size-cells = <1>;
		ranges;

		rsvd@41200000 {
			reg = <0x41200000 0x300000>;
			no-map;
		};
	};

	leds {
		compatible = "gpio-leds";

		pinctrl-0 = <&leds_pins>;
		pinctrl-names = "default";

		led_status_red: status_red {
			label = "red:status";
			gpios = <&qcom_pinmux 27 GPIO_ACTIVE_HIGH>;
		};

		led_status_green: status_green {
			label = "green:status";
			gpios = <&qcom_pinmux 28 GPIO_ACTIVE_HIGH>;
		};

	};

	keys {
		compatible = "gpio-keys";

		pinctrl-0 = <&button_pins>;
		pinctrl-names = "default";

		reset {
			label = "reset";
			gpios = <&qcom_pinmux 29 GPIO_ACTIVE_LOW>;
			linux,code = <KEY_RESTART>;
			debounce-interval = <60>;
			wakeup-source;
		};
	};

	gpio-export {
		compatible = "gpio-export";

		pinctrl-0 = <&gpio_pins>;
		pinctrl-names = "default";

		ble_reset: gpio_ble_reset {
			gpio-export,name = "ble_reset";
			gpio-export,output = <1>;
			gpios = <&qcom_pinmux 31 GPIO_ACTIVE_LOW>;
		};

		ble_status: gpio_ble_status {
			gpio-export,name = "ble_status";
			gpio-export,output = <0>;
			gpios = <&qcom_pinmux 32 GPIO_ACTIVE_HIGH>;
		};

		ble_active: gpio_ble_active {
			gpio-export,name = "ble_status";
			gpio-export,output = <0>;
			gpios = <&qcom_pinmux 63 GPIO_ACTIVE_HIGH>;
		};

		poe_status: gpio_poe_status {
			gpio-export,name = "poe_status";
			gpio-export,output = <0>;
			gpios = <&qcom_pinmux 15 GPIO_ACTIVE_LOW>;
		};
	};
};

&qcom_pinmux {
	spi_pins: spi_pins {
		mux {
			pins = "gpio18", "gpio19", "gpio21";
			function = "gsbi5";
			drive-strength = <10>;
			bias-none;
		};

		cs {
			pins = "gpio20";
			drive-strength = <12>;
		};
	};

	hci_uart_pins: hci_uart_pins {
		mux {
			pins = "gpio22", "gpio23", "gpio24", "gpio25";
			function = "gsbi2";
			drive-strength = <12>;
			bias-disable;
		};
	};

	gpio_pins: gpio_pins {
		ble_reset {
			pins = "gpio31";
			function = "gpio";
			drive-strength = <12>;
			bias-pull-down;
			output-low;
		};

		ble_status {
			pins = "gpio32", "gpio63", "gpio68";
			function = "gpio";
			drive-strength = <12>;
			bias-disable;
		};

		poe_status {
			pins = "gpio15";
			function = "gpio";
			drive-strength = <2>;
			bias-pull-down;
		};
	};

	leds_pins: leds_pins {
		mux {
			pins = "gpio27", "gpio28";
			function = "gpio";
			drive-strength = <2>;
			bias-pull-down;
			output-low;
		};
	};

	button_pins: button_pins {
		mux {
			pins = "gpio29";
			function = "gpio";
			drive-strength = <2>;
			bias-pull-up;
		};
	};

	i2c7_pins: i2c7_pins {
		mux {
			pins = "gpio8", "gpio9";
			function = "gsbi7";
			drive-strength = <12>;
			bias-disable;
		};
	};
};

&adm_dma {
	status = "okay";
};

&CPU_SPC {
	status = "disabled";
};

&gsbi2 {
	qcom,mode = <GSBI_PROT_UART_W_FC>;
	status = "okay";
};

&gsbi2_serial {
	status = "okay";
	pinctrl-0 = <&hci_uart_pins>;
	pinctrl-names = "default";

	qcom,rx-crci = <14>;
	qcom,tx-crci = <4>;
	dmas = <&adm_dma 7>,
	       <&adm_dma 8>;
	dma-names = "tx", "rx";
};

&gsbi4 {
	qcom,mode = <GSBI_PROT_I2C_UART>;
	status = "okay";
	/*
	* The i2c device on gsbi4 should not be enabled.
	* On ipq806x designs gsbi4 i2c is meant for exclusive
	* RPM usage. Turning this on in kernel manifests as
	* i2c failure for the RPM.
	*/
};

&gsbi4_serial {
	status = "okay";
	/* Bluetooth HCI UART port, CSR8811 */
};

&gsbi5 {
	status = "okay";
	qcom,mode = <GSBI_PROT_SPI>;

	gsbi5_spi: spi@1a280000 {
		status = "okay";
		spi-max-frequency = <50000000>;

		pinctrl-0 = <&spi_pins>;
		pinctrl-names = "default";

		cs-gpios = <&qcom_pinmux 20 GPIO_ACTIVE_HIGH>;

		flash0: mx25u3235f@0 {
			compatible = "jedec,spi-nor";
			#address-cells = <1>;
			#size-cells = <1>;
			spi-max-frequency = <50000000>;
			reg = <0>;
			m25p,fast-read;

			partitions {
				compatible = "fixed-partitions";
				#address-cells = <1>;
				#size-cells = <1>;

				partition@0 {
					label = "SBL1";
					reg = <0x0 0x10000>;
					read-only;
				};

				partition@10000 {
					label = "MIBIB";
					reg = <0x10000 0x20000>;
					read-only;
				};

				partition@30000 {
					label = "SBL2";
					reg = <0x30000 0x30000>;
					read-only;
				};

				partition@60000 {
					label = "SBL3";
					reg = <0x60000 0x30000>;
					read-only;
				};

				partition@90000 {
					label = "DDRCONFIG";
					reg = <0x90000 0x10000>;
					read-only;
				};

				partition@a0000 {
					label = "APPSBLENV";
					reg = <0xa0000 0x10000>;
				};

				art: partition@b0000 {
					label = "ART";
					reg = <0xb0000 0x10000>;
					read-only;
				};

				partition@c0000 {
					label = "TZ";
					reg = <0xc0000 0x30000>;
					read-only;
				};

				partition@f0000 {
					label = "RPM";
					reg = <0xf0000 0x20000>;
					read-only;
				};

				partition@110000 {
					label = "APPSBL";
					reg = <0x110000 0x90000>;
					read-only;
				};

				partition@1a0000 {
					label = "stat_cfg";
					reg = <0x1a0000 0x60000>;
				};

				partition@200000 {
					label = "dyn_cfg";
					reg = <0x200000 0x100000>;
				};

				partition@300000 {
					label = "dyn_cfg_backup";
					reg = <0x300000 0x100000>;
				};
			};
		};
	};
};

&gsbi7 {
	status = "okay";
	qcom,mode = <GSBI_PROT_I2C>;
};

&gsbi7_i2c {
	status = "okay";
	pinctrl-0 = <&i2c7_pins>;
	pinctrl-names = "default";

	tpm: tpm@29 {
		reg = <0x29>;
		compatible = "atmel,at97sc3204t";
		reset-gpio = <&qcom_pinmux 59 GPIO_ACTIVE_HIGH>;
	};
};

&mdio0 {
	status = "okay";

	pinctrl-0 = <&mdio0_pins>;
	pinctrl-names = "default";

	phy1: ethernet-phy@1 {
		reg = <1>;
	};

	phy2: ethernet-phy@2 {
		reg = <2>;
	};
};

&gmac2 {
	status = "okay";

	qcom,id = <2>;
	mdiobus = <&mdio0>;

	phy-mode = "sgmii";
	phy-handle = <&phy1>;

	// nvmem-cells = <&macaddr_art_0>;
	// nvmem-cell-names = "mac-address";

	local-mac-address = [00 00 00 00 00 00]; /* Set by U-Boot */
};

&gmac3 {
	status = "okay";

	qcom,id = <3>;
	mdiobus = <&mdio0>;

	phy-mode = "sgmii";
	phy-handle = <&phy2>;

	// nvmem-cells = <&macaddr_art_6>;
	// nvmem-cell-names = "mac-address";

	local-mac-address = [00 00 00 00 00 00]; /* Set by U-Boot */
};

&nand_controller {
	status = "okay";

	pinctrl-0 = <&nand_pins>;
	pinctrl-names = "default";

	flash1: nand@0 {
		reg = <0>;
		compatible = "qcom,nandcs";

		nand-bus-width = <8>;

		partitions {
			compatible = "fixed-partitions";
			#address-cells = <1>;
			#size-cells = <1>;

			partition@0 {
				label = "rootfs";
				reg = <0x0 0x20000000>;
			};
		};
	};
};

&pcie0 {
	status = "okay";
};

&pcie1 {
	status = "okay";
};

&hs_phy_0 {
	status = "disabled";
};

&ss_phy_0 {
	status = "disabled";
};

&hs_phy_1 {
	status = "disabled";
};

&ss_phy_1 {
	status = "disabled";
};

&rpm {
	pinctrl-0 = <&i2c4_pins>;
	pinctrl-names = "default";
};

&tcsr {
	status = "okay";
};

&art {
	compatible = "nvmem-cells";
	#address-cells = <1>;
	#size-cells = <1>;

	macaddr_art_0: macaddr@0 {
		reg = <0x0 0x6>;
	};

	macaddr_art_6: macaddr@6 {
		reg = <0x6 0x6>;
	};

	macaddr_art_12: macaddr@12 {
		reg = <0x12 0x6>;
	};
};
