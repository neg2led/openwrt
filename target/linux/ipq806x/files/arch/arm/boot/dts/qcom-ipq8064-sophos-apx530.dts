// SPDX-License-Identifier: GPL-2.0-or-later OR MIT

#include "qcom-ipq8064-v1.0.dtsi"
#include <dt-bindings/interrupt-controller/arm-gic.h>
#include <dt-bindings/interrupt-controller/irq.h>
#include <dt-bindings/input/input.h>
#include <dt-bindings/gpio/gpio.h>

/ {
	model = "Sophos APX530";
	compatible = "sophos,apx530", "qcom,ipq8064";

	reserved-memory {
		#address-cells = <1>;
		#size-cells = <1>;
		ranges;
		rsvd@41200000 {
			reg = <0x41200000 0x300000>;
			no-map;
		};
	};

	aliases {
		mdio-gpio0 = &mdio0;
		ethernet0 = &gmac3;
		ethernet1 = &gmac2;
	};

	soc {


		i2c@0 {
			compatible = "i2c-gpio";
			pinctrl-0 = <&i2c_pins>;
			gpios = <&qcom_pinmux 8 0>,
				<&qcom_pinmux 9 0>;
			i2c-gpio,delay-us = <2>;	/* ~100 kHz */
			#address-cells = <1>;
			#size-cells = <0>;
			status="okay";
			tpm@0x29 {
				reg = <0x29>;
				compatible = "atmel,at97sc3204t";
				reset-gpio = <&qcom_pinmux 59 0>;
			};
		};

		gsbi@16300000 {
			qcom,mode = <GSBI_PROT_I2C_UART>;
			status = "okay";
			serial@16340000 {
				status = "okay";
			};
		};

		gsbi2: gsbi@12480000 {
			qcom,mode = <GSBI_PROT_UART_W_FC>;
			status = "okay";
			hs_uart@12490000 {
				uartdm_rx_buf_size = <1024>;
				qcom,rx-chan = <8>;
				qcom,tx-chan = <7>;
				qcom,rx-crci = <14>;
				qcom,tx-crci = <4>;
				qcom,tcsr_adm_mux_sel_reg = <IPQ806X_TCSR_REG_A_ADM_CRCI_MUX_SEL>;
				qcom,tcsr_adm_mux_sel_reg_mask = <IPQ806X_GSBI2_ADM_CRCI_MUX_SEL_MASK>;
				qcom,tcsr_adm_mux_sel_reg_value = <GSBI_CRCI_UART>;
				pinctrl-0 = <&hs_uart_pins>;
				pinctrl-names = "default";

				status = "okay";
			};
		};



		pci@1b500000 {
			status = "okay";
			reset-gpio = <&qcom_pinmux 3 0>;
			pinctrl-0 = <&pcie1_pins>;
			pinctrl-names = "default";

			ranges = <0x00000000 0 0x00000000 0x0ff00000 0 0x00100000   /* configuration space */
				  0x81000000 0 0	  0x0fe00000 0 0x00100000   /* downstream I/O */
				  0x82000000 0 0x00000000 0x08000000 0 0x07e00000>; /* non-prefetchable memory */
		};

		pci@1b700000 {
			status = "okay";
			reset-gpio = <&qcom_pinmux 48 0>;
			pinctrl-0 = <&pcie2_pins>;
			pinctrl-names = "default";

			ranges = <0x00000000 0 0x00000000 0x31f00000 0 0x00100000   /* configuration space */
				  0x81000000 0 0	  0x31e00000 0 0x00100000   /* downstream I/O */
				  0x82000000 0 0x00000000 0x2e000000 0 0x03e00000>; /* non-prefetchable memory */

		};



		dma@18300000 {
			status = "okay";
		};

		gpio_keys {
			compatible = "gpio-keys";

			button@1 {
				label = "reset";
				linux,code = <KEY_RESTART>;
				gpios = <&qcom_pinmux 60 GPIO_ACTIVE_LOW>;
				linux,input-type = <1>;
				debounce-interval = <60>;
			};
		};

		gpio-leds {
			compatible = "gpio-leds";
			pinctrl-0 = <&led_0_pins>;

			led_green@0 {
				gpios = <&qcom_pinmux 28 0>;
				label = "green";
				default-state = "on";
				linux,default-trigger = "timer";
			};

			led_red@1 {
				gpios = <&qcom_pinmux 27 0>;
				label = "red";
				default-state = "off";
			};
		};

		mdio0: mdio {
			compatible = "virtual,mdio-gpio";
			#address-cells = <1>;
			#size-cells = <0>;
			gpios = <&qcom_pinmux 1 0 &qcom_pinmux 0 0>;

			phy0: ethernet-phy@0 {
				device_type = "ethernet-phy";
				reg = <1>;
			};

			phy1: ethernet-phy@1 {
				device_type = "ethernet-phy";
				reg = <2>;
			};
		};

		nss0: nss@40000000 {
			compatible = "qcom,nss";
			interrupts = <GIC_SPI 213 IRQ_TYPE_LEVEL_HIGH>,
				     <GIC_SPI 232 IRQ_TYPE_LEVEL_HIGH>;
			reg = <0x36000000 0x1000 0x39000000 0x10000>;
			reg-names = "nphys", "vphys";
			clocks = <&gcc NSS_CORE_CLK>, <&gcc NSSTCM_CLK_SRC>,
				 <&gcc NSSTCM_CLK>, <&nss_fabric0_clk>,
				 <&nss_fabric1_clk>;
			clock-names = "nss-core-clk", "nss-tcm-src",
				      "nss-tcm-clk", "nss-fab0-clk",
				      "nss-fab1-clk";
			resets = <&gcc UBI32_CORE1_CLKRST_CLAMP_RESET>,
				 <&gcc UBI32_CORE1_CLAMP_RESET>,
				 <&gcc UBI32_CORE1_AHB_RESET>,
				 <&gcc UBI32_CORE1_AXI_RESET>;
			reset-names = "clkrst-clamp", "clamp", "ahb", "axi";

			qcom,id = <0>;
			qcom,num-irq = <2>;
			qcom,num-queue = <2>;
			qcom,load-addr = <0x40000000>;
			qcom,turbo-frequency;

			qcom,ipv4-enabled;
			qcom,ipv6-enabled;
			qcom,l2tpv2-enabled;
			qcom,map-t-enabled;
			qcom,pptp-enabled;
			qcom,portid-enabled;
			qcom,shaping-enabled;
			qcom,tun6rd-enabled;
			qcom,tunipip6-enabled;
			qcom,wlan-dataplane-offload-enabled;
			qcom,wlanredirect-enabled;
		};

		nss1: nss@40800000 {
			compatible = "qcom,nss";
			interrupts = <GIC_SPI 214 IRQ_TYPE_LEVEL_HIGH>,
				     <GIC_SPI 233 IRQ_TYPE_LEVEL_HIGH>;
			reg = <0x36400000 0x1000 0x39010000 0x10000>;
			reg-names = "nphys", "vphys";
			resets = <&gcc UBI32_CORE2_CLKRST_CLAMP_RESET>,
				 <&gcc UBI32_CORE2_CLAMP_RESET>,
				 <&gcc UBI32_CORE2_AHB_RESET>,
				 <&gcc UBI32_CORE2_AXI_RESET>;
			reset-names = "clkrst-clamp", "clamp", "ahb", "axi";

			qcom,id = <1>;
			qcom,num-irq = <2>;
			qcom,num-queue = <2>;
			qcom,load-addr = <0x40800000>;
			qcom,turbo-frequency;

			qcom,capwap-enabled;
			qcom,crypto-enabled;
			qcom,dtls-enabled;
			qcom,ipsec-enabled;
		};

		gmac0: ethernet@37000000 {
			device_type = "network";
			compatible = "qcom,nss-gmac";
			reg = <0x37000000 0x200000>;
			interrupts = <GIC_SPI 220 IRQ_TYPE_LEVEL_HIGH>;
			phy-mode = "sgmii";
			qcom,id = <0>;
			qcom,pcs-chanid = <2>;
			qcom,phy-mdio-addr = <5>;
			qcom,poll-required = <1>;
			qcom,rgmii-delay = <0>;
			qcom,emulation = <0>;
			qcom,forced-speed = <0>;
			qcom,forced-duplex = <0>;
			qcom,socver = <0>;
			local-mac-address = [000000000000];
			mdiobus = <&mdio0>;
			status = "disabled";
		};

		gmac1: ethernet@37200000 {
			device_type = "network";
			compatible = "qcom,nss-gmac";
			reg = <0x37200000 0x200000>;
			interrupts = <GIC_SPI 223 IRQ_TYPE_LEVEL_HIGH>;
			phy-mode = "sgmii";
			qcom,id = <1>;
			qcom,pcs-chanid = <1>;
			qcom,phy-mdio-addr = <4>;
			qcom,poll-required = <1>;
			qcom,rgmii-delay = <0>;
			qcom,emulation = <0>;
			qcom,forced-speed = <0>;
			qcom,forced-duplex = <0>;
			qcom,socver = <0>;
			local-mac-address = [000000000000];
			mdiobus = <&mdio0>;
			status = "disabled";
		};

		gmac2: ethernet@37400000 {
			device_type = "network";
			compatible = "qcom,nss-gmac";
			reg = <0x37400000 0x200000>;
			interrupts = <GIC_SPI 226 IRQ_TYPE_LEVEL_HIGH>;
			phy-mode = "sgmii";
			qcom,id = <2>;
			qcom,pcs-chanid = <2>;
			qcom,phy-mdio-addr = <1>;
			qcom,poll-required = <1>;
			qcom,rgmii-delay = <0>;
			qcom,emulation = <0>;
			qcom,forced-speed = <0>;
			qcom,forced-duplex = <0>;
			qcom,socver = <0>;
			local-mac-address = [000000000000];
			mdiobus = <&mdio0>;
		};

		gmac3: ethernet@37600000 {
			device_type = "network";
			compatible = "qcom,nss-gmac";
			reg = <0x37600000 0x200000>;
			interrupts = <0 229 4>;
			phy-mode = "sgmii";
			qcom,id = <3>;
			qcom,pcs-chanid = <3>;
			qcom,phy-mdio-addr = <2>;
			qcom,poll-required = <1>;
			qcom,rgmii-delay = <0>;
			qcom,emulation = <0>;
			qcom,forced-speed = <0>;
			qcom,forced-duplex = <0>;
			qcom,mmds-mask = <0>;
			qcom,socver = <0>;
			local-mac-address = [000000000000];
			mdiobus = <&mdio0>;
		  };
	};
};

&qcom_pinmux {
	pinctrl-0 = <&led_0_pins>;
	pinctrl-names = "default";

	rpm_i2c_pinmux: rpm_i2c_pinmux {
		mux {
			pins = "gpio12", "gpio13";
			function = "gsbi4";
			drive-strength = <12>;
			bias-disable;
		};
	};

	pcie1_pins: pcie1_pinmux {
		mux {
			pins = "gpio3";
			drive-strength = <2>;
			bias-disable;
		};
	};

	pcie2_pins: pcie2_pinmux {
		mux {
			pins = "gpio48";
			drive-strength = <2>;
			bias-disable;
		};
	};

	spi_pins: spi_pins {
		mux {
			pins = "gpio18", "gpio19", "gpio21";
			function = "gsbi5";
			drive-strength = <10>;
			bias-none;
		};
		cs {
			pins = "gpio20";
			drive-strength = <12>;
		};
	};

	nand_pins: nand_pins {
		mux {
			pins = "gpio34", "gpio35", "gpio36",
				"gpio37", "gpio38", "gpio39",
				"gpio40", "gpio41", "gpio42",
				"gpio43", "gpio44", "gpio45",
				"gpio46", "gpio47";
			function = "nand";
			drive-strength = <10>;
			bias-disable;
		};
		pullups {
			pins = "gpio39";
			bias-pull-up;
		};
		hold {
			pins = "gpio40", "gpio41", "gpio42",
				"gpio43", "gpio44", "gpio45",
				"gpio46", "gpio47";
			bias-bus-hold;
		};
	};

	hs_uart_pins: hs_uart_pins {
		mux {
			pins = "gpio22", "gpio23", "gpio24", "gpio25" ;
			function = "gsbi2";
			drive-strength = <12>;
			bias-disable;
		};
	};

	led_0_pins: led_pins {
		mux {
			pins = "gpio27", "gpio28";
			function = "gpio";
			drive-strength = <2>;
			bias-pull-down;
			output-low;
		};
	};

	i2c_pins: i2c_pins {
		mux {
			pins = "gpio8", "gpio9";
			function = "gpio";
			drive-open-drain;
		};
	};
};

&gsbi5 {
	status = "okay";
	qcom,mode = <GSBI_PROT_SPI>;

	spi4: spi@1a280000 {
		status = "okay";

		pinctrl-0 = <&spi_pins>;
		pinctrl-names = "default";
		cs-gpios = <&qcom_pinmux 20 0>;

		dmas = <&adm_dma 6 9>,
			<&adm_dma 5 10>;
		dma-names = "rx", "tx";

		nand1: flash@0 {
			compatible = "s25fl256s1";
			#address-cells = <1>;
			#size-cells = <1>;
			reg = <0>;
			m25p,fast-read;


			partitions {
				compatible = "fixed-partitions";
				#address-cells = <1>;
				#size-cells = <1>;

				partition@0 {
					label = "SBL1";
					reg = <0x0 0x10000>;
					read-only;
				}

				partition@10000 {
					label = "MIBIB";
					reg = <0x10000 0x20000>;
					read-only;
				};

				partition@30000 {
					label = "SBL2";
					reg = <0x30000 0x30000>;
					read-only;
				};

				partition@60000 {
					label = "SBL3";
					reg = <0x60000 0x30000>;
					read-only;
				};

				partition@90000 {
					label = "DDRCONFIG";
					reg = <0x90000 0x10000>;
					read-only;
				};

				partition@a0000 {
					label = "APPSBLENV";
					reg = <0xa0000 0x10000>;
				};

				art: partition@b0000 {
					label = "ART";
					reg = <0xb0000 0x10000>;
					read-only;
				};

				partition@c0000 {
					label = "TZ";
					reg = <0xc0000 0x30000>;
					read-only;
				};

				partition@f0000 {
					label = "RPM";
					reg = <0xf0000 0x20000>;
					read-only;
				};

				partition@110000 {
					label = "APPSBL";
					reg = <0x110000 0x90000>;
					read-only;
				};

				partition@1a0000 {
					label = "stat_cfg";
					reg = <0x1a0000 0x60000>;
					read-only;
				};

				partition@200000 {
					label = "dyn_cfg";
					reg = <0x200000 0x100000>;
					read-only;
				};

				partition@300000 {
					label = "dyn_cfg_backup";
					reg = <0x300000 0x100000>;
					read-only;
				};
			};
		};
	};
};

&rpm {
	pinctrl-0 = <&rpm_i2c_pinmux>;
	pinctrl-names = "default";
};

&adm_dma {
	status = "okay";
}

&nand_controller {
	status = "okay";

	pinctrl-0 = <&nand_pins>;
	pinctrl-names = "default";
};

&tcsr {
	status = "okay";
	qcom,usb-ctrl-select = <TCSR_USB_SELECT_USB3_DUAL>;
};

&hs_phy_0 {
	status = "disabled";
}

&ss_phy_0 {
	status = "disabled";
}

&hs_phy_1 {
	status = "disabled";
}

&ss_phy_1 {
	status = "disabled";
}
